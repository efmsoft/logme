name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  prepare-release-notes:
    name: prepare-release-notes
    runs-on: ubuntu-latest
    outputs:
      notes_path: ${{ steps.notes.outputs.notes_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract release notes from changelog.md
        id: notes
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          out="release-notes-${tag}.md"

          if [ ! -f "changelog.md" ]; then
            echo "changelog.md not found, using fallback notes" > "$out"
            echo "" >> "$out"
            echo "Release: $tag" >> "$out"
            echo "notes_path=$out" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ver="${tag#v}"

          awk -v ver="$ver" '
            BEGIN { inside=0; found=0 }
            {
              if ($0 ~ "^##[[:space:]]*\\[?" ver "\\]?") { inside=1; found=1; print; next }
              if (inside && $0 ~ "^##[[:space:]]") { exit }
              if (inside) { print }
            }
            END {
              if (!found) {
                print "Release: v" ver
                print ""
                print "(No matching section found in changelog.md; please update it or adjust the header format.)"
              }
            }
          ' changelog.md > "$out"

          echo "notes_path=$out" >> "$GITHUB_OUTPUT"

      - name: Upload notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: ${{ steps.notes.outputs.notes_path }}
          if-no-files-found: error

  windows-msvc-x64:
    name: windows-msvc-x64-${{ matrix.kind }}
    runs-on: windows-latest
    needs: prepare-release-notes
    strategy:
      fail-fast: false
      matrix:
        kind: [static, shared]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE

          $bdir = Join-Path $ws ("build\" + $kind)
          $stageRoot = Join-Path $ws "stage"
          $prefix = Join-Path $stageRoot ("logme-${{ github.ref_name }}-windows-msvc-x64-" + $kind)

          New-Item -ItemType Directory -Force -Path $bdir | Out-Null
          New-Item -ItemType Directory -Force -Path $prefix | Out-Null

          $static = "OFF"
          $shared = "OFF"
          if ($kind -eq "static") { $static = "ON" }
          if ($kind -eq "shared") { $shared = "ON" }

          cmake -S $ws -B $bdir -G "Visual Studio 17 2022" -A x64 `
            -DLOGME_BUILD_STATIC=$static `
            -DLOGME_BUILD_DYNAMIC=$shared `
            -DLOGME_BUILD_EXAMPLES=OFF `
            -DLOGME_BUILD_TESTS=OFF `
            -DLOGME_BUILD_TOOLS=OFF `
            -DLOGME_ENABLE_INSTALL=ON `
            -DUSE_JSONCPP=OFF `
            -DLOGME_STD_FORMAT=AUTO
          if ($LASTEXITCODE -ne 0) { throw "cmake configure failed: $LASTEXITCODE" }

      - name: Build (Release)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE
          $bdir = Join-Path $ws ("build\" + $kind)

          cmake --build $bdir --config Release
          if ($LASTEXITCODE -ne 0) { throw "cmake build failed: $LASTEXITCODE" }

      - name: Install
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE

          $bdir = Join-Path $ws ("build\" + $kind)
          $stageRoot = Join-Path $ws "stage"
          $prefix = Join-Path $stageRoot ("logme-${{ github.ref_name }}-windows-msvc-x64-" + $kind)

          cmake --install $bdir --config Release --prefix $prefix
          if ($LASTEXITCODE -ne 0) { throw "cmake install failed: $LASTEXITCODE" }

      - name: Verify staging contains headers and libraries
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE
          $stageRoot = Join-Path $ws "stage"
          $prefix = Join-Path $stageRoot ("logme-${{ github.ref_name }}-windows-msvc-x64-" + $kind)

          Write-Host "Staging prefix: $prefix"
          if (-not (Test-Path $prefix))
          {
            Write-Host "ERROR: prefix directory does not exist"
            exit 1
          }

          $inc = Join-Path $prefix "include"
          $lib = Join-Path $prefix "lib"
          $bin = Join-Path $prefix "bin"
          $missing = @()

          if (-not (Test-Path $inc)) { $missing += "include/" }
          if (-not (Test-Path $lib)) { $missing += "lib/" }

          if ($kind -eq "static")
          {
            $staticLib = Join-Path $lib "logme.lib"
            if (-not (Test-Path $staticLib)) { $missing += "lib/logme.lib" }
          }
          else
          {
            if (-not (Test-Path $bin)) { $missing += "bin/" }
            $dll = Join-Path $bin "logmed.dll"
            $implib = Join-Path $lib "logmed.lib"
            if (-not (Test-Path $dll)) { $missing += "bin/logmed.dll" }
            if (-not (Test-Path $implib)) { $missing += "lib/logmed.lib" }
          }

          $cmakeDir = Join-Path $lib "cmake\logme"
          if (-not (Test-Path $cmakeDir)) { $missing += "lib/cmake/logme/" }

          if ($missing.Count -gt 0)
          {
            Write-Host "ERROR: staging is missing required files:"
            $missing | ForEach-Object { Write-Host "  - $_" }

            Write-Host ""
            Write-Host "Directory tree (prefix):"
            Get-ChildItem -Recurse -Force $prefix | Select-Object FullName

            exit 1
          }

          Write-Host "OK: staging contains headers and libraries."

      - name: Add docs to staging
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE
          $stageRoot = Join-Path $ws "stage"
          $prefix = Join-Path $stageRoot ("logme-${{ github.ref_name }}-windows-msvc-x64-" + $kind)

          $shareDir = Join-Path $prefix "share\logme"
          New-Item -ItemType Directory -Force -Path $shareDir | Out-Null

          $files = @("LICENSE", "README.md", "changelog.md")
          foreach ($f in $files)
          {
            if (Test-Path (Join-Path $ws $f))
            {
              Copy-Item (Join-Path $ws $f) (Join-Path $shareDir $f) -Force
            }
          }

      - name: Pack + SHA256
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $kind = "${{ matrix.kind }}"
          $ws = $env:GITHUB_WORKSPACE
          $stageRoot = Join-Path $ws "stage"

          $name = "logme-${{ github.ref_name }}-windows-msvc-x64-$kind"
          $dir = Join-Path $stageRoot $name
          $zip = Join-Path $ws ("$name.zip")
          $sha = Join-Path $ws ("$name.zip.sha256.txt")

          if (Test-Path $zip) { Remove-Item -Force $zip }

          Compress-Archive -Path (Join-Path $dir "*") -DestinationPath $zip
          if ($LASTEXITCODE -ne 0) { throw "Compress-Archive failed: $LASTEXITCODE" }

          $hashLine = (certutil -hashfile $zip SHA256 | Select-String -Pattern "^[0-9A-Fa-f]{64}$").Line
          "$hashLine  $name.zip" | Out-File -Encoding ascii $sha

      - name: Download release notes artifact
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Create/Update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes-${{ github.ref_name }}.md
          files: |
            logme-${{ github.ref_name }}-windows-msvc-x64-${{ matrix.kind }}.zip
            logme-${{ github.ref_name }}-windows-msvc-x64-${{ matrix.kind }}.zip.sha256.txt

  linux-ubuntu-22:
    name: linux-ubuntu-22.04-release
    runs-on: ubuntu-22.04
    needs: prepare-release-notes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        shell: bash
        run: |
          set -euo pipefail
          bdir="build/linux"
          prefix="stage/logme-${GITHUB_REF_NAME}-linux-ubuntu-22.04-x64"
          cmake -S . -B "$bdir" \
            -DCMAKE_BUILD_TYPE=Release \
            -DLOGME_BUILD_STATIC=ON \
            -DLOGME_BUILD_DYNAMIC=OFF \
            -DLOGME_BUILD_EXAMPLES=OFF \
            -DLOGME_BUILD_TESTS=OFF \
            -DLOGME_BUILD_TOOLS=OFF \
            -DLOGME_ENABLE_INSTALL=ON \
            -DUSE_JSONCPP=OFF \
            -DLOGME_STD_FORMAT=AUTO
          cmake --build "$bdir" --config Release
          cmake --install "$bdir" --prefix "$prefix"

          mkdir -p "$prefix/share/logme"
          for f in LICENSE README.md changelog.md; do
            if [ -f "$f" ]; then
              cp -f "$f" "$prefix/share/logme/$f"
            fi
          done

      - name: Pack + SHA256
        shell: bash
        run: |
          set -euo pipefail
          name="logme-${GITHUB_REF_NAME}-linux-ubuntu-22.04-x64"
          (cd stage && tar -czf "../${name}.tar.gz" "${name}")
          sha256sum "${name}.tar.gz" > "${name}.tar.gz.sha256.txt"

      - name: Download release notes artifact
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Create/Update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes-${{ github.ref_name }}.md
          files: |
            logme-${{ github.ref_name }}-linux-ubuntu-22.04-x64.tar.gz
            logme-${{ github.ref_name }}-linux-ubuntu-22.04-x64.tar.gz.sha256.txt
