name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  linux:
    name: Linux / ${{ matrix.compiler }} / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [ gcc, clang ]
        config: [ Debug, Release ]
        stdformat: [ on, off ]
        include:
          - compiler: gcc
            cxx: g++
          - compiler: clang
            cxx: clang++

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Configure
        shell: bash
        env:
          CXX: ${{ matrix.cxx }}
        run: |
          set -euxo pipefail
          extra_cxx_flags=""
          if [ "${{ matrix.stdformat }}" = "off" ]; then
            extra_cxx_flags="-DLOGME_DISABLE_STD_FORMAT"
          fi
          extra_cxx_flags="${extra_cxx_flags} -Wall -Wextra -Wpedantic -Werror"
          cmake -S . -B "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_C_FLAGS="-Wall -Wextra -Wpedantic -Werror" \
            -DCMAKE_CXX_FLAGS="${extra_cxx_flags}"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --output-on-failure

  macos:
    name: macOS / ${{ matrix.os }} / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
        config: [ Debug, Release ]
        stdformat: [ on, off ]

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Install deps
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install googletest pkg-config

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          extra_cxx_flags=""
          if [ "${{ matrix.stdformat }}" = "off" ]; then
            extra_cxx_flags="-DLOGME_DISABLE_STD_FORMAT"
          fi
          extra_cxx_flags="${extra_cxx_flags} -Wall -Wextra -Wpedantic -Werror"

          gtest_dir="$(brew --prefix googletest)/lib/cmake/GTest"

          cmake -S . -B "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_CXX_STANDARD=20 \
            -DBUILD_TESTING=ON \
            -DGTest_DIR="${gtest_dir}" \
            -DCMAKE_C_FLAGS="-Wall -Wextra -Wpedantic -Werror" \
            -DCMAKE_CXX_FLAGS="${extra_cxx_flags}"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --output-on-failure

  windows:
    name: Windows / msvc / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release ]
        stdformat: [ on, off ]

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure
        shell: pwsh
        run: |
          $extra = ""
          if ("${{ matrix.stdformat }}" -eq "off") { $extra = "/DLOGME_DISABLE_STD_FORMAT" }
          $extra = "$extra /W4 /WX"

          cmake -S . -B "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
            -DCMAKE_CXX_STANDARD=20 `
            -DCMAKE_CXX_COMPILER=cl `
            -DCMAKE_C_COMPILER=cl `
            -DCMAKE_C_FLAGS="/W4 /WX" `
            -DCMAKE_CXX_FLAGS="$extra"

      - name: Build
        shell: pwsh
        run: |
          cmake --build "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: pwsh
        run: |
          ctest --test-dir "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --output-on-failure

  windows_msbuild_sln:
    name: Windows / MSBuild (repo .sln) / ${{ matrix.config }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release ]

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build solution (repo logme.sln)
        shell: pwsh
        run: |
          msbuild .\logme.sln `
            /m `
            /p:Configuration=${{ matrix.config }} `
            /p:Platform=x64 `
            /p:WarningLevel=Level4 `
            /p:TreatWarningsAsErrors=true

  linux_x86:
    name: Linux / gcc / Release / x86 (warnings-as-errors)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Install deps (multilib)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends g++-multilib

      - name: Configure
        shell: bash
        env:
          CXX: g++
        run: |
          set -euxo pipefail
          cmake -S . -B "build/linux/gcc/Release/x86" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_C_FLAGS="-m32 -Wall -Wextra -Wpedantic -Werror" \
            -DCMAKE_CXX_FLAGS="-m32 -Wall -Wextra -Wpedantic -Werror"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build/linux/gcc/Release/x86" --config Release

  windows_x86:
    name: Windows / msvc / Release / x86 (warnings-as-errors)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Setup MSVC dev cmd (x86)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Configure
        shell: pwsh
        run: |
          cmake -S . -B "build/windows/msvc/Release/x86" `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_CXX_STANDARD=20 `
            -DCMAKE_CXX_COMPILER=cl `
            -DCMAKE_C_COMPILER=cl `
            -DCMAKE_CXX_FLAGS="/W4 /WX" `
            -DCMAKE_C_FLAGS="/W4 /WX"

      - name: Build
        shell: pwsh
        run: |
          cmake --build "build/windows/msvc/Release/x86" --config Release
