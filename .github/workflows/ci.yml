name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  linux:
    name: Linux / ${{ matrix.compiler }} / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [ gcc, clang ]
        config: [ Debug, Release ]
        stdformat: [ on, off ]
        include:
          - compiler: gcc
            cxx: g++
          - compiler: clang
            cxx: clang++

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Configure
        shell: bash
        env:
          CXX: ${{ matrix.cxx }}
        run: |
          set -euxo pipefail
          extra_cxx_flags=""
          if [ "${{ matrix.stdformat }}" = "off" ]; then
            extra_cxx_flags="-DLOGME_DISABLE_STD_FORMAT"
          fi
          cmake -S . -B "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_CXX_FLAGS="${extra_cxx_flags}"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir "build/linux/${{ matrix.compiler }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --output-on-failure

  macos:
    name: macOS / ${{ matrix.os }} / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
        config: [ Debug, Release ]
        stdformat: [ on, off ]

    steps:
      - uses: actions/checkout@v4
      - uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Install deps
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install googletest pkg-config

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          extra_cxx_flags=""
          if [ "${{ matrix.stdformat }}" = "off" ]; then
            extra_cxx_flags="-DLOGME_DISABLE_STD_FORMAT"
          fi

          gtest_dir="$(brew --prefix googletest)/lib/cmake/GTest"

          cmake -S . -B "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_CXX_STANDARD=20 \
            -DBUILD_TESTING=ON \
            -DGTest_DIR="${gtest_dir}" \
            -DCMAKE_CXX_FLAGS="${extra_cxx_flags}"

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: bash
        run: |
          set -euxo pipefail
          ctest --test-dir "build/macos/${{ matrix.os }}/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --output-on-failure

  windows:
    name: Windows / MSBuild / ${{ matrix.config }} / stdformat-${{ matrix.stdformat }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release ]
        stdformat: [ on, off ]

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure
        shell: pwsh
        run: |
          $extra = ""
          if ("${{ matrix.stdformat }}" -eq "off") { $extra = "-DLOGME_DISABLE_STD_FORMAT" }

          cmake -S . -B "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_CXX_STANDARD=20 `
            -DCMAKE_CXX_FLAGS="$extra"

      - name: Build
        shell: pwsh
        run: |
          cmake --build "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" --config ${{ matrix.config }}

      - name: Test
        shell: pwsh
        run: |
          ctest --test-dir "build/windows/msvc/${{ matrix.config }}/stdformat-${{ matrix.stdformat }}" -C ${{ matrix.config }} --output-on-failure
